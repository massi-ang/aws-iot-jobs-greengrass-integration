# A sample stack for AWS IoT Greengrass Job agent

## Prerequisites

### Certificate

* Create an AWS IoT Certificate in the console or via the command line

```bash
aws iot create-keys-and-certificate --set-as-active --private-key-outfile certs/client.pem.key \
     --certificate-pem-outfile certs/client.pem.crt --query "certificateArn"
```

If you use the Console, download the private key and public certificate to your machine and rename them respectively `client.pem.key` and `client.pem.crt` and put them in the `certs` folder.

### A device with AWS IoT Greengrass Core software

Follow the instructions [here](https://docs.aws.amazon.com/greengrass/latest/developerguide/install-ggc.html) to prepare a device for AWS IoT Greengrass.

## Deploy the stack

Run the following commands, replacing the value of the parameter with the ARN of the certificate you create before 

```bash
cd gg-stack
npm i
npm run build
cdk deploy --cdk deploy --parameters certificateArnCore=arn:aws:iot....
```

When the stack has finished, it will have created a new Group

To configure the group, replace the UPPERCASE tags in the `./config/config.json` file with their actual values.

Copy the `/config/config.json` file to the greengrass installation folder (`/greengrass/config`).
Copy the certificate and private keys generated by the first command to `/greengrass/certs`.

Start greengrass with `sudo /greengrass/ggc/core/greengrassd start`.

Go to the AWS IoT Greengrass console and deploy the group.

### Create a job

Now that you have a Greengrass up and running the job agent, follow the instructions [here](https://docs.aws.amazon.com/iot/latest/developerguide/manage-job-console.html) to create a AWS IoT Job. At step 6, select the Thing Core called `gg_core` as target. You can skip steps 8-10.

As the job is sumbmitted it will immediately be processed by the Greengrass device and should transition in the "Successful" state.

You can inspect the logs of the agent lambda running on Greengrass by executing:

```bash
tail -f /greemgrass/ggc/var/log/user/<region>/<account>/gg-jobs-lambda-....log
```

### Modify the job agent lambda

You find the code of the agent in `./gg_jobs_lambda/src/lambda.py`.

Modify the code and redeploy the stack.

## Useful commands

 * `npm run build`   compile typescript to js
 * `npm run watch`   watch for changes and compile
 * `npm run test`    perform the jest unit tests
 * `cdk deploy`      deploy this stack to your default AWS account/region
 * `cdk diff`        compare deployed stack with current state
 * `cdk synth`       emits the synthesized CloudFormation template
